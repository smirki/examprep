<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1 class="my-4">Practice</h1>
        <div id="question-container">
            <!-- Questions will be injected here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const examId = urlParams.get('id');
            const userUpvotes = new Set();

            loadQuestions(examId).then(questions => {
                let currentQuestionIndex = 0;
                let askAgainQuestions = [];

                function showQuestion() {
                    if (currentQuestionIndex < questions.length) {
                        const question = questions[currentQuestionIndex];
                        const questionContainer = document.getElementById('question-container');
                        questionContainer.innerHTML = `
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Question ${currentQuestionIndex + 1}</h5>
                                    <p class="card-text">${question.question}</p>
                                    <input type="text" id="user-answer" class="form-control" placeholder="Your answer">
                                    <button class="btn btn-primary mt-3" id="submit-answer">Submit</button>
                                    <button class="btn btn-secondary mt-3" id="ask-again-later">Ask Again Later</button>
                                    <div class="mt-3">
                                        <button class="btn btn-success" id="upvote">Upvote (${question.upvotes})</button>
                                        <button class="btn btn-danger" id="downvote">Downvote (${question.downvotes})</button>
                                        <button class="btn btn-warning" id="report">Report</button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.getElementById('submit-answer').addEventListener('click', () => {
                            const userAnswer = document.getElementById('user-answer').value;
                            if (evaluateAnswer(userAnswer, question.answer)) {
                                alert('Correct!');
                            } else {
                                alert('Incorrect. Try again.');
                                askAgainQuestions.push(question);
                            }
                            currentQuestionIndex++;
                            showQuestion();
                        });

                        document.getElementById('ask-again-later').addEventListener('click', () => {
                            askAgainQuestions.push(question);
                            currentQuestionIndex++;
                            showQuestion();
                        });

                        document.getElementById('upvote').addEventListener('click', () => {
                            if (!userUpvotes.has(question.question)) {
                                question.upvotes++;
                                updateQuestion(examId, question).then(() => {
                                    userUpvotes.add(question.question);
                                    showQuestion();
                                });
                            } else {
                                alert('You can only upvote once.');
                            }
                        });

                        document.getElementById('downvote').addEventListener('click', () => {
                            question.downvotes++;
                            updateQuestion(examId, question).then(() => {
                                showQuestion();
                            });
                        });

                        document.getElementById('report').addEventListener('click', () => {
                            reportQuestion(question).then(() => {
                                alert('Question reported.');
                            });
                        });
                    } else if (askAgainQuestions.length > 0) {
                        questions = askAgainQuestions;
                        askAgainQuestions = [];
                        currentQuestionIndex = 0;
                        showQuestion();
                    } else {
                        document.getElementById('question-container').innerHTML = `
                            <h3>All questions completed!</h3>
                            <a href="index.html" class="btn btn-primary">Back to Main Menu</a>
                        `;
                    }
                }
                showQuestion();
            });
        });
    </script>
    <script src="js/utils.js"></script>
</body>
</html>
